version: '3'

services:

  redis:
    image: redis
    restart: always
    ports:
      - 6379:6379
      
  db:
    image: mariadb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_SUPER_USER_PW}
    ports:
      - 3306:3306
    volumes:
      # - ./init:/docker-entrypoint-initdb.d
      - ${DATABASE_DATA}:/var/lib/mysql

  adminer:
    image: adminer
    restart: always
    ports:
      - 9091:8080

  rabbitmq:
    image: hulk66/timeline_rabbitmq:${IMAGE_VERSION}
    build: config/rabbitmq
    # image: rabbitmq:management
    hostname: rabbitmq
    restart: always
    ports:
      - 5672:5672
      - 15672:15672
    volumes:
      - ${RABBITMQ_DATA}:/var/lib/rabbitmq

  webapp:
    image: hulk66/timeline_be:${IMAGE_VERSION}
    # build: backend
    restart: always
    ports: 
      - 9092:5000
    volumes:
      - ${ASSET_PATH}:/photos
      - ${PREVIEW_PATH}:/preview
      - ${LOG_PATH}:/log
    environment:
      APP: "web"
      WAIT_HOSTS: db:3306, rabbitmq:5672 
      WAIT_HOSTS_TIMEOUT: 120
      WAIT_SLEEP_INTERVAL: 3    
      WAIT_AFTER_HOSTS: 2
      DB_SUPER_USER_PW: ${DB_SUPER_USER_PW}
      GUNICORN_WORKERS: ${GUNICORN_WORKERS}
      GUNICORN_WORKER_CLASS: ${GUNICORN_WORKER_CLASS}
      FACE_DISTANCE_VERY_SAFE: ${FACE_DISTANCE_VERY_SAFE}
      FACE_DISTANCE_SAFE: ${FACE_DISTANCE_SAFE}
      FACE_DISTANCE_MAYBE: ${FACE_DISTANCE_MAYBE}
      FACE_CLUSTER_MAX_FACES: ${FACE_CLUSTER_MAX_FACES}
      UPLOAD_FOLDER: ${UPLOAD_FOLDER}
      TIMELINE_BASEPATH: ${TIMELINE_BASEPATH}
    depends_on:
      - db
      - rabbitmq

  worker:
    image: hulk66/timeline_be:${IMAGE_VERSION}
    # build: backend
    restart: always
    environment:
      APP: "worker"
      WORKERS_PROCESS: ${WORKERS_PROCESS}
      WAIT_HOSTS: db:3306, rabbitmq:5672, webapp:5000 
      WAIT_HOSTS_TIMEOUT: 180
      WAIT_SLEEP_INTERVAL: 3     
      WAIT_AFTER_HOSTS: 2
      DB_SUPER_USER_PW: ${DB_SUPER_USER_PW}
      FACE_CLUSTER_EPSILON: ${FACE_CLUSTER_EPSILON}
      FACE_CLUSTER_MIN_SAMPLES: ${FACE_CLUSTER_MIN_SAMPLES}
      FACE_CLUSTER_MAX_FACES: ${FACE_CLUSTER_MAX_FACES}
      FACE_DISTANCE_VERY_SAFE: ${FACE_DISTANCE_VERY_SAFE}
      FACE_DISTANCE_SAFE: ${FACE_DISTANCE_SAFE}
      FACE_DISTANCE_MAYBE: ${FACE_DISTANCE_MAYBE}
      #INITIAL_SCAN: {INITIAL_SCAN}
      #POLLING: {POLLING}
    volumes:
      - ${ASSET_PATH}:/photos:ro
      - ${PREVIEW_PATH}:/preview
      - ${LOG_PATH}:/log
    depends_on:
      - webapp
      - db
      - rabbitmq

  transcoder:
    image: hulk66/timeline_be:${IMAGE_VERSION}
    # build: backend
    restart: always
    environment:
      APP: "transcoder"
      WAIT_HOSTS: db:3306, rabbitmq:5672, webapp:5000 
      WAIT_HOSTS_TIMEOUT: 180
      WAIT_SLEEP_INTERVAL: 3     
      WAIT_AFTER_HOSTS: 2
      DB_SUPER_USER_PW: ${DB_SUPER_USER_PW}
    volumes:
      - ${ASSET_PATH}:/photos:ro
      - ${PREVIEW_PATH}:/preview
      - ${LOG_PATH}:/log
    depends_on:
      - webapp
      - db
      - rabbitmq

  frontend:
    image: hulk66/timeline_fe:${IMAGE_VERSION}
    # build: frontend
    restart: always
    ports:
      - 9090:80
    volumes:
      - ${ASSET_PATH}:/photos:ro
      - ${PREVIEW_PATH}:/preview
    environment:
      TIMELINE_BASEPATH: ${TIMELINE_BASEPATH}
      BE_HOST: webapp
      BE_PORT: 5000
      WAIT_HOSTS: webapp:5000
      WAIT_HOSTS_TIMEOUT: 180
      WAIT_SLEEP_INTERVAL: 3     
      WAIT_AFTER_HOSTS: 2
    depends_on:
      - webapp

  watchdog:
    image: hulk66/timeline_be:${IMAGE_VERSION}
    # build: backend
    restart: always
    environment:
      APP: "watchdog"
      WAIT_HOSTS: db:3306, rabbitmq:5672, webapp:5000 # redis:6379
      WAIT_HOSTS_TIMEOUT: 180
      WAIT_SLEEP_INTERVAL: 3     
      WAIT_AFTER_HOSTS: 2
      DB_SUPER_USER_PW: ${DB_SUPER_USER_PW}
    volumes:
      - ${ASSET_PATH}:/photos:ro
      - ${LOG_PATH}:/log
    depends_on:
      - webapp
